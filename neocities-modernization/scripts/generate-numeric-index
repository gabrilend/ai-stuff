#!/usr/bin/env lua

-- Numeric Similarity Index Generator
-- Generates a dense, CTRL+F-searchable block of numbered links (001-7791)
-- pointing to similar/XXX.html pages. Output is an HTML fragment for insertion
-- into index.html. Each row contains LINKS_PER_ROW links in monospace format.

-- {{{ setup_dir_path
local function setup_dir_path(provided_dir)
    if provided_dir and provided_dir ~= "" then
        return provided_dir
    end
    return "/mnt/mtwo/programming/ai-stuff/neocities-modernization"
end
-- }}}

local DIR = setup_dir_path(arg[1])

-- Configuration
local LINKS_PER_ROW = 15
local OUTPUT_FILE = nil  -- nil = stdout, or set path for file output

-- Add libs to package path
package.path = DIR .. "/libs/?.lua;" .. package.path

local dkjson = require("dkjson")

-- {{{ read_poem_count
local function read_poem_count()
    local poems_path = DIR .. "/assets/poems.json"
    local file = io.open(poems_path, "r")
    if not file then
        io.stderr:write("Error: Could not open " .. poems_path .. "\n")
        os.exit(1)
    end

    local content = file:read("*a")
    file:close()

    local data = dkjson.decode(content)
    if not data or not data.metadata or not data.metadata.total_poems then
        io.stderr:write("Error: Could not parse poem count from poems.json\n")
        os.exit(1)
    end

    return data.metadata.total_poems
end
-- }}}

-- {{{ format_link
local function format_link(num)
    -- Zero-pad to 4 digits for alignment (handles up to 9999 poems)
    local padded = string.format("%04d", num)
    return string.format('<a href="similar/%s.html">%s</a>', padded, padded)
end
-- }}}

-- {{{ generate_index
local function generate_index(total_poems)
    local lines = {}
    local current_row = {}

    for i = 1, total_poems do
        table.insert(current_row, format_link(i))

        if #current_row >= LINKS_PER_ROW then
            table.insert(lines, table.concat(current_row, " "))
            current_row = {}
        end
    end

    -- Handle remaining links in last row
    if #current_row > 0 then
        table.insert(lines, table.concat(current_row, " "))
    end

    return lines
end
-- }}}

-- {{{ main
local function main()
    local total_poems = read_poem_count()
    io.stderr:write(string.format("Generating index for %d poems...\n", total_poems))

    local lines = generate_index(total_poems)

    -- Build output
    local output = {}
    table.insert(output, "<pre>")
    for _, line in ipairs(lines) do
        table.insert(output, line)
    end
    table.insert(output, "</pre>")

    local html = table.concat(output, "\n")

    -- Write to stdout or file
    if OUTPUT_FILE then
        local file = io.open(DIR .. "/" .. OUTPUT_FILE, "w")
        if file then
            file:write(html)
            file:close()
            io.stderr:write(string.format("Written to %s\n", OUTPUT_FILE))
        else
            io.stderr:write("Error: Could not write to " .. OUTPUT_FILE .. "\n")
            os.exit(1)
        end
    else
        print(html)
    end

    io.stderr:write(string.format("Generated %d links in %d rows\n", total_poems, #lines))
end
-- }}}

main()
