# Issue 8-001: Unified Website Generation Pipeline

## Overview

This issue tracks the complete pipeline from raw input files to deployed static website. The pipeline consists of multiple stages, each with its own scripts and dependencies.

## Current Behavior

The `run.sh` script currently runs 7 stages:

| Stage | Name | Script | Description |
|-------|------|--------|-------------|
| 1 | Update Words | `scripts/update-words` | Sync input files from words repository |
| 2 | Extract | `scripts/update` | Extract content from backup archives |
| 3 | Parse | `src/main.lua --parse-only` | Generate `assets/poems.json` |
| 4 | Validate | `src/main.lua --validate-only` | Validate poems and generate report |
| 5 | Catalog Images | `src/main.lua --catalog-only` | Generate `assets/image-catalog.json` |
| 6 | Generate HTML | `src/main.lua --html-only` | Generate chronological + similarity pages |
| 7 | Generate Index | `scripts/generate-numeric-index` | Generate numeric similarity index |

**Pipeline Gap**: Stages 6-7 depend on embeddings and similarity data that are NOT generated by the pipeline:

```
Required by HTML generation:
├── assets/embeddings/embeddinggemma_latest/embeddings.json (62MB)
├── assets/embeddings/embeddinggemma_latest/similarity_matrix.json
└── assets/embeddings/embeddinggemma_latest/similarities/*.json (diversity cache)
```

These must be generated separately via:
- `./generate-embeddings.sh` (~2-3 hours for full corpus)
- `scripts/generate-html-parallel` (generates similarity matrix as side-effect)
- `scripts/precompute-diversity-sequences` (~42 hours for full corpus)

## Intended Behavior

A complete 10-stage pipeline that can regenerate the entire website from scratch:

| Stage | Name | Script | Time Estimate | Dependencies |
|-------|------|--------|---------------|--------------|
| 1 | Update Words | `scripts/update-words` | <1 min | None |
| 2 | Extract | `scripts/update` | <1 min | Stage 1 |
| 3 | Parse | `src/main.lua --parse-only` | ~30 sec | Stage 2 |
| 4 | Validate | `src/main.lua --validate-only` | ~10 sec | Stage 3 |
| 5 | Catalog Images | `src/main.lua --catalog-only` | ~5 sec | Stage 2 |
| **6** | **Generate Embeddings** | `generate-embeddings.sh` | ~2-3 hours | Stage 3 |
| **7** | **Build Similarity Matrix** | `scripts/generate-similarity-matrix` | ~30 min | Stage 6 |
| **8** | **Build Diversity Cache** | `scripts/precompute-diversity-sequences` | ~42 hours | Stage 7 |
| 9 | Generate HTML | `scripts/generate-html-parallel` | ~10 min | Stages 7-8 |
| 10 | Generate Index | `scripts/generate-numeric-index` | <1 min | Stage 9 |

### Dependency Graph

```
[1: Update Words]
        ↓
[2: Extract Archives]
        ↓
[3: Parse Poems] ──────────────────────────────┐
        ↓                                      │
[4: Validate] ─→ (optional, can skip)          │
        ↓                                      ↓
[5: Catalog Images]                  [6: Generate Embeddings]
        │                                      ↓
        │                            [7: Similarity Matrix]
        │                                      ↓
        │                            [8: Diversity Cache]
        │                                      ↓
        └──────────────────────────→ [9: Generate HTML]
                                               ↓
                                     [10: Generate Index]
```

### Incremental Pipeline

For day-to-day updates (few new poems), the pipeline can skip expensive stages:

```bash
./run.sh --parse --validate --generate-html  # ~5 minutes
```

For full regeneration (major changes or first-time setup):

```bash
./run.sh --all --force  # ~45 hours (dominated by diversity cache)
```

## Implementation Steps

### Phase 1: HTML Integration ✅ COMPLETED

- [x] Renamed "unique" to "different" in navigation
- [x] Added `<meta charset="UTF-8">` to all HTML templates
- [x] Integrated `flat-html-generator.lua` into `src/main.lua`
- [x] Added "Generate website HTML" menu option (option 6)
- [x] Implemented `M.is_html_fresh()` freshness check function
- [x] Implemented `M.generate_website_html(force)` with dependency validation
- [x] Updated `run.sh` to trigger full website generation

### Phase 2: Parallel HTML Generation ✅ COMPLETED

- [x] Created `scripts/generate-html-parallel` using effil library
- [x] Similarity page generation working (10 pages/sec with 4 threads)
- [x] Diversity page generation working via cached sequences
- [x] Batch-based thread pool with progress reporting
- [x] Added `--incremental` flag for skip existing files
- [x] Added `--threads=N` for configurable parallelism

### Phase 3: Embedding Integration ✅ COMPLETED

- [x] Add `--generate-embeddings` flag to `run.sh`
- [x] Add freshness check: skip if embeddings.json newer than poems.json
- [x] Add incremental mode: delegated to `generate-embeddings.sh --incremental`
- [x] Handle Ollama connection failures gracefully (error message with model name)
- [x] Add `--model` option (default: embeddinggemma:latest)

### Phase 4: Similarity Matrix Integration ✅ COMPLETED

- [x] Add `--generate-similarity` flag to `run.sh`
- [x] Calls `similarity-engine.lua generate_similarity_matrix()` function
- [x] Add freshness check: skip if matrix newer than embeddings.json
- [x] Dependency check: fail early if embeddings.json missing

### Phase 5: Diversity Cache Integration ✅ COMPLETED

- [x] Add `--generate-diversity` flag to `run.sh`
- [x] Integrate `scripts/precompute-diversity-sequences` into pipeline
- [x] Add freshness check: skip if cache newer than embeddings.json
- [x] Thread count via `DIVERSITY_THREADS` environment variable
- [x] Dependency check: fail early if embeddings.json missing

### Phase 6: Pipeline Orchestration ✅ COMPLETED

- [x] Add `--full` flag that runs all 10 stages including embeddings
- [x] `--all` flag runs fast stages only (1-5, 9-10) - backward compatible
- [x] Add dependency validation: fail early if required files missing
- [x] Freshness checks for all embedding-related stages
- [x] Updated TUI menu with new stages (marked ⚠️ for expensive ones)
- [x] Verbose mode shows time estimates for expensive stages

## Existing Scripts

### `generate-embeddings.sh` (698 lines)

Full-featured embedding generation script with:
- Batch processing with configurable size
- Retry logic with exponential backoff
- Progress saving and resume capability
- JSON validation and repair
- Multiple output formats

### `scripts/generate-html-parallel`

Multi-threaded HTML generation with:
- Similarity page generation via effil workers
- Diversity page generation from cached sequences
- Batch-based thermal management
- Incremental mode (skip existing files)

### `scripts/precompute-diversity-sequences`

Diversity cache precomputation with:
- O(n²) similarity calculations
- Per-poem diversity sequence generation
- JSON output per poem_index
- Progress tracking and resume capability

## Dependencies

| File | Generated By | Required For |
|------|--------------|--------------|
| `assets/poems.json` | Stage 3 (Parse) | All later stages |
| `assets/image-catalog.json` | Stage 5 (Catalog) | HTML generation |
| `embeddings/*/embeddings.json` | Stage 6 (Embeddings) | Similarity/Diversity |
| `embeddings/*/similarity_matrix.json` | Stage 7 (Matrix) | HTML generation |
| `embeddings/*/similarities/*.json` | Stage 8 (Diversity) | Diversity pages |

## Quality Assurance Criteria

### From Original Issue (Phase 1)
- [x] `run.sh` generates complete website without manual intervention
- [x] Navigation links in chronological.html point to correct files
- [x] "different" terminology used consistently (not "unique")

### Full Pipeline Criteria
- [x] `run.sh --all` generates complete website from scratch (using cached embeddings)
- [x] `run.sh --full` runs all 10 stages including embedding generation
- [ ] All poem IDs have corresponding similar/{category}-{id}.html files
- [ ] All poem IDs have corresponding different/{category}-{id}.html files
- [x] Generation completes in reasonable time (<10 minutes for incremental)
- [x] Pipeline fails early with clear error if dependencies missing
- [x] Resume capability works after interruption (via freshness checks)

## Related Issues

- **Issue 8-002**: Implement multi-threaded HTML generation (COMPLETED)
- **Issue 8-004**: Implement embedding validation (COMPLETED)
- **Issue 8-019**: Implement unique poem_index system (COMPLETED)
- **Issue 9-003**: Optimize centroid calculation and parallelization

## Notes

### Full Generation File Count

Expected output for complete generation:
- 1 × chronological.html (~12MB)
- 1 × index.html (copy)
- 1 × explore.html
- ~7,600 × similar/{category}-{id}.html (one per poem)
- ~7,600 × different/{category}-{id}.html (one per poem)
- Total: ~15,203 HTML files

### Long-Running Operations

The diversity cache (Stage 8) takes ~42 hours due to O(n²) similarity calculations for 7,600 poems. Options to address this:
1. **Accept the time**: Run overnight/over weekend
2. **Reduce precision**: Sample instead of exhaustive calculation
3. **Parallelize more**: Distribute across multiple machines
4. **Cache aggressively**: Only regenerate for new/changed poems

---

**ISSUE STATUS: IN PROGRESS** (Phases 1-6 complete, pending full HTML generation test)

**Created**: 2025-12-14

**Last Updated**: 2025-12-25

**Phase**: 8 (Website Completion)

## Implementation Log

### 2025-12-23: Phases 1-2 Completed

- Added `flat-html-generator` and `dkjson` to required modules in `src/main.lua`
- Added "Generate website HTML" as menu option 6
- Implemented `M.is_html_fresh()` for freshness checking
- Implemented `M.generate_website_html(force)` with dependency validation
- Created `scripts/generate-html-parallel` with multi-threaded generation
- Added flexible argument parsing (--threads, --incremental, etc.)
- Tested chronological index generation: 12.1MB file with 99,970 lines

### 2025-12-25: Issue Scope Expanded

- Expanded issue from "HTML Integration" to "Unified Pipeline"
- Documented full 10-stage pipeline architecture
- Identified missing stages: embedding, similarity matrix, diversity cache
- Added Phase 3-6 implementation steps for full pipeline integration
- Updated dependency graph and completion criteria

### 2025-12-25: Phases 3-6 Implemented

- Added `--generate-embeddings` flag with freshness check (skip if newer than poems.json)
- Added `--generate-similarity` flag with freshness check and dependency validation
- Added `--generate-diversity` flag with freshness check and dependency validation
- Added `--full` flag to run all 10 stages (vs `--all` which runs fast stages only)
- Added `--model` option for embedding model selection
- Updated TUI menu with new stages (6-8 marked with ⚠️, default OFF)
- Updated stage numbering from 7 to 10 throughout `run.sh`
- All three new stages have:
  - Dependency checks (fail early if embeddings.json missing)
  - Freshness checks (skip if output newer than input)
  - Dry-run support
  - Verbose logging with time estimates
