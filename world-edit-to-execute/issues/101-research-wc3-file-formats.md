# Issue 101: Research WC3 File Formats

**Phase:** 1 - Foundation
**Type:** Research
**Priority:** Critical (Blocker for all other Phase 1 issues)
**Dependencies:** None

---

## Current Behavior

No documentation exists in this project regarding WC3 file format specifications.
Development cannot proceed without understanding the binary structures we need to parse.

---

## Intended Behavior

Comprehensive documentation of all file formats needed for Phase 1, stored in
`docs/formats/` for reference during implementation. This includes:

- MPQ archive format (container for .w3m/.w3x files)
- war3map.w3i format (map metadata)
- war3map.wts format (trigger strings table)
- war3map.w3e format (terrain elevation/tiles)

---

## Suggested Implementation Steps

1. **Create documentation directory structure**
   ```
   docs/formats/
   ├── mpq-archive.md
   ├── w3i-map-info.md
   ├── wts-trigger-strings.md
   └── w3e-terrain.md
   ```

2. **Research MPQ archive format**
   - Study Blizzard's MPQ (Mo'PaQ) archive format
   - Document header structure (magic bytes, version, hash table offset, block table offset)
   - Document hash table entry format
   - Document block table entry format
   - Document compression methods (PKWARE, zlib, bzip2)
   - Reference existing implementations (StormLib, libmpq)

3. **Research war3map.w3i format**
   - Document file header and version
   - Map name, author, description fields
   - Player slot definitions
   - Force definitions
   - Loading screen settings
   - Map flags and options

4. **Research war3map.wts format**
   - Document string table structure
   - String ID to content mapping
   - Encoding considerations (UTF-8 vs legacy)

5. **Research war3map.w3e format**
   - Document terrain tile format
   - Height map encoding
   - Tile texture indices
   - Water level data
   - Cliff/ramp encoding

6. **Validate documentation against test files**
   - Use hex editor to verify documented structures against DAoW maps in assets/
   - Note any version-specific variations

---

## Related Documents

- docs/roadmap.md (Phase 1 requirements)
- assets/*.w3x (test map files)

## External References

- http://www.wc3c.net/tools/specs/ (WC3 file format specifications)
- https://github.com/stormlib/StormLib (reference MPQ implementation)
- https://github.com/ChimeraCoder/wc3-replay-parser (format insights)
- http://wiki.thehelper.net/wc3/ (community documentation)

---

## Acceptance Criteria

- [x] docs/formats/mpq-archive.md exists with complete header/table documentation
- [x] docs/formats/w3i-map-info.md exists with field-by-field breakdown
- [x] docs/formats/wts-trigger-strings.md exists with format specification
- [x] docs/formats/w3e-terrain.md exists with terrain data layout
- [x] All format docs validated against at least one test .w3x file
- [x] Table of contents updated with new documentation

---

## Notes

This is a research-only issue. No code should be written until this documentation
is complete, as implementation decisions depend on understanding the exact binary
layouts we're working with.

The MPQ format is particularly complex due to multiple compression algorithms and
hash-based file lookup. Consider whether to use an existing library (StormLib) or
implement from scratch for educational/licensing reasons.

---

## Sub-Issue Analysis

*Generated by Claude Code on 2025-12-15 23:51*

I have the issue content from your message. Let me analyze it.

## Analysis

This issue is a good candidate for splitting. It covers **four distinct file formats**, each requiring independent research and producing separate documentation. The work is naturally parallelizable and each sub-issue has clear boundaries.

## Suggested Sub-Issues

### 101a-research-mpq-archive-format
**Description:** Research and document the MPQ (Mo'PaQ) archive format, which is the container format for .w3m/.w3x map files.

**Covers:**
- Header structure (magic bytes, version, hash table offset, block table offset)
- Hash table entry format
- Block table entry format  
- Compression methods (PKWARE, zlib, bzip2)
- Reference existing implementations (StormLib, libmpq)
- Decision: use existing library vs implement from scratch

**Dependencies:** None

**Output:** `docs/formats/mpq-archive.md`

---

### 101b-research-w3i-map-info-format
**Description:** Research and document the war3map.w3i file format containing map metadata.

**Covers:**
- File header and version bytes
- Map name, author, description fields
- Player slot definitions
- Force definitions
- Loading screen settings
- Map flags and options
- Version-specific variations

**Dependencies:** 101a (need to extract .w3i from MPQ to validate)

**Output:** `docs/formats/w3i-map-info.md`

---

### 101c-research-wts-trigger-strings-format
**Description:** Research and document the war3map.wts file format for localized trigger strings.

**Covers:**
- String table structure
- String ID to content mapping
- Encoding considerations (UTF-8 vs legacy encodings)
- How strings are referenced by other files

**Dependencies:** 101a (need to extract .wts from MPQ to validate)

**Output:** `docs/formats/wts-trigger-strings.md`

---

### 101d-research-w3e-terrain-format
**Description:** Research and document the war3map.w3e file format for terrain data.

**Covers:**
- Terrain tile format
- Height map encoding
- Tile texture indices
- Water level data
- Cliff/ramp encoding
- Map dimensions and coordinate systems

**Dependencies:** 101a (need to extract .w3e from MPQ to validate)

**Output:** `docs/formats/w3e-terrain.md`

---

## Dependency Graph

```
101a (MPQ Archive)
    ├── 101b (W3I Map Info)
    ├── 101c (WTS Trigger Strings)
    └── 101d (W3E Terrain)
```

## Recommendation

**Split this issue.** The benefits are:

1. **Clear ownership** - Each sub-issue produces exactly one document
2. **Parallelizable** - 101b, 101c, 101d can be worked in parallel after 101a completes
3. **Trackable progress** - Can mark MPQ research complete while still working on terrain
4. **Appropriate granularity** - Each sub-issue is 1-3 hours of focused research work
5. **Natural blocking order** - MPQ must be understood first since it's the container format

The parent issue 101 should remain as a tracking issue that's considered complete when all four sub-issues are done.

---

## Implementation Notes

*Completed 2025-12-16*

### Documents Created

1. **docs/formats/mpq-archive.md** - Comprehensive MPQ format documentation including:
   - Archive header structure (magic, offsets, sizes)
   - HM3W wrapper format (512-byte WC3-specific header)
   - Hash table format and hashing algorithm
   - Block table format and flags
   - Encryption/decryption algorithms with Lua code
   - Compression methods (zlib, PKWARE DCL, bzip2)
   - Sector format for large files
   - WC3-specific quirks discovered during validation

2. **docs/formats/w3i-map-info.md** - Map info format including:
   - Header fields (version, saves, editor)
   - Variable-length strings with TRIGSTR support
   - Camera bounds and playable area
   - Map flags bitmask (16 flags documented)
   - Player slot structure (type, race, position)
   - Force/team definitions
   - TFT-specific fields (fog, weather, colors)

3. **docs/formats/wts-trigger-strings.md** - String table format including:
   - Text-based STRING <id> { content } syntax
   - TRIGSTR_XXX reference resolution
   - Color codes (|cffRRGGBB...|r)
   - Multi-line string handling
   - Lua parsing code examples

4. **docs/formats/w3e-terrain.md** - Terrain format including:
   - Header with tileset and dimension info
   - 7-byte tilepoint structure with bit layouts
   - Height encoding and coordinate systems
   - Ground texture and cliff variation indices
   - Terrain flags (ramp, blight, water, boundary)
   - Cliff model selection algorithm

### Validation Results

Validated against DAoW-2.1.w3x:
- HM3W header correctly parsed at offset 0x00
- MPQ archive found at offset 0x200 with valid magic
- Archive size matches (file_size - 512)
- Hash/block table offsets and entry counts valid
- Tables contain properly encrypted data

### Key Findings

1. WC3 maps use HM3W wrapper before MPQ archive
2. HeaderSize field in MPQ header contains unexpected value in WC3 maps
3. Pure Lua implementation is feasible using string.unpack for binary parsing
4. lua-zlib recommended for compression, PKWARE DCL needs custom implementation

### Sources Used

- [wowdev.wiki/MPQ](https://wowdev.wiki/MPQ)
- [StormLib documentation](https://github.com/dcramer/ghostplusplus/blob/master/StormLib/doc/The%20MoPaQ%20File%20Format%201.0.txt)
- [W3X Files Format](https://867380699.github.io/blog/2019/05/09/W3X_Files_Format)
- [HiveWE wiki - war3map.w3e](https://github.com/stijnherfst/HiveWE/wiki/war3map.w3e-Terrain)
- [WC3MapSpecification](https://github.com/ChiefOfGxBxL/WC3MapSpecification)
