# Issue 006: Rename Analysis Sections for Promoted Roots

**Phase:** 0 - Tooling/Infrastructure
**Type:** Enhancement
**Priority:** Low
**Affects:** src/cli/issue-splitter.sh
**Dependencies:** 003-execute-analysis-recommendations

---

## Current Behavior

When an issue is analyzed for splitting, a `## Sub-Issue Analysis` section is appended.
When a root issue with sub-issues is reviewed, a `## Structure Review` section is appended.

However, when sub-issues are created from the analysis recommendations, the original
`## Sub-Issue Analysis` section remains with that name. This creates ambiguity:

- The section describes the *initial* analysis that led to the split
- But after promotion to root, the issue may receive additional structure reviews
- Both types of analysis live in the same file with similar-sounding names

---

## Intended Behavior

When an issue is "promoted" to a root node (i.e., sub-issues are created from its
analysis), the original `## Sub-Issue Analysis` section should be renamed to
`## Initial Analysis` to distinguish it from future `## Structure Review` sections.

### Section Naming Convention

| Section | When Created | Purpose |
|---------|--------------|---------|
| `## Initial Analysis` | After sub-issues generated | Original analysis that led to the split |
| `## Structure Review` | During Phase 2 review | Review of root + existing sub-issues |

### Example Flow

1. **Before split:** Issue 102 has `## Sub-Issue Analysis` recommending 102a, 102b, 102c
2. **After split:** Sub-issues created, section renamed to `## Initial Analysis`
3. **Later review:** Phase 2 adds `## Structure Review` evaluating 102 + 102a/b/c

---

## Suggested Implementation Steps

### 1. Add Rename Function

```bash
# {{{ rename_analysis_to_initial
rename_analysis_to_initial() {
    local issue_path="$1"

    # Only rename if has Sub-Issue Analysis but not already renamed
    if grep -qE "^## Sub-Issue Analysis$" "$issue_path" && \
       ! grep -qE "^## Initial Analysis$" "$issue_path"; then
        sed -i 's/^## Sub-Issue Analysis$/## Initial Analysis/' "$issue_path"
        log "  Renamed analysis section to 'Initial Analysis'"
    fi
}
# }}}
```

### 2. Call After Sub-Issue Generation

In `execute_recommendations()` (from issue 003), after successfully creating
sub-issues, call the rename function:

```bash
# After generating sub-issue files
if [[ $created -gt 0 ]]; then
    rename_analysis_to_initial "$issue_path"
fi
```

### 3. Update Detection Functions

Add a function to check for initial analysis:

```bash
# {{{ has_initial_analysis
has_initial_analysis() {
    local file="$1"
    grep -qE "^## Initial Analysis$" "$file" 2>/dev/null
}
# }}}
```

### 4. Update Skip Logic (Optional)

Consider whether `--skip-existing` should also skip issues with `## Initial Analysis`:

```bash
if [[ "$SKIP_EXISTING" == true ]]; then
    if has_subissue_analysis "$issue_path" || has_initial_analysis "$issue_path"; then
        log "  Skipping (already has analysis)"
        return 0
    fi
fi
```

---

## File State Examples

### Before Promotion (has analysis, no sub-issues yet)

```markdown
# Issue 102: Implement MPQ Archive Parser

...content...

---

## Sub-Issue Analysis

*Generated by Claude Code on 2025-12-16*

Recommend splitting into 102a, 102b, 102c, 102d...
```

### After Promotion (sub-issues created)

```markdown
# Issue 102: Implement MPQ Archive Parser

...content...

---

## Initial Analysis

*Generated by Claude Code on 2025-12-16*

Recommend splitting into 102a, 102b, 102c, 102d...

---

## Generated Sub-Issues

*Auto-generated on 2025-12-16*

- 102a-parse-mpq-header.md
- 102b-parse-mpq-hash-table.md
- 102c-parse-mpq-block-table.md
- 102d-implement-file-extraction.md
```

### After Structure Review

```markdown
# Issue 102: Implement MPQ Archive Parser

...content...

---

## Initial Analysis

*Generated by Claude Code on 2025-12-16*

Recommend splitting into 102a, 102b, 102c, 102d...

---

## Generated Sub-Issues

*Auto-generated on 2025-12-16*

- 102a-parse-mpq-header.md
- ...

---

## Structure Review

*Generated by Claude Code on 2025-12-17*

Reviewed root + sub-issues. Recommend...
```

---

## Related Documents

- issues/003-execute-analysis-recommendations.md (where rename would be called)
- src/cli/issue-splitter.sh
- issues/001-fix-issue-splitter-output-handling.md (detection patterns)

---

## Acceptance Criteria

- [ ] `rename_analysis_to_initial()` function exists
- [ ] Section renamed when sub-issues are created from analysis
- [ ] Only renames `## Sub-Issue Analysis`, not `## Initial Analysis`
- [ ] `has_initial_analysis()` detection function exists
- [ ] Skip logic respects both analysis types
- [ ] Existing `## Structure Review` sections unaffected

---

## Notes

This maintains the full history of an issue's evolution:
1. Initial analysis (what prompted the split)
2. Generated sub-issues (what was created)
3. Structure reviews (ongoing refinement)

The naming makes it clear which analysis is "original" vs "ongoing review".

---

## Implementation Log

**Date:** 2024-12-16

### Changes Made

1. **Added `has_initial_analysis()` function** (line 177-181)
   - Detects if issue has "## Initial Analysis" section
   - Used for skip logic

2. **Added `rename_analysis_to_initial()` function** (line 184-194)
   - Renames "## Sub-Issue Analysis" to "## Initial Analysis"
   - Only renames if not already renamed
   - Logs the rename action

3. **Updated skip logic** (line 559-565)
   - Now checks both `has_subissue_analysis` and `has_initial_analysis`
   - Either analysis type causes skip when --skip-existing is set

4. **Called rename after sub-issue generation** (line 958-959)
   - In `execute_recommendations()`, after sub-issues are created and parent updated
   - Rename happens automatically as part of execution flow

### Acceptance Criteria Resolution

- [x] `rename_analysis_to_initial()` function exists
- [x] Section renamed when sub-issues are created from analysis
- [x] Only renames `## Sub-Issue Analysis`, not `## Initial Analysis`
- [x] `has_initial_analysis()` detection function exists
- [x] Skip logic respects both analysis types
- [x] Existing `## Structure Review` sections unaffected
