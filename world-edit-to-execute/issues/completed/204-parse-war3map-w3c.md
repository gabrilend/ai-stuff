# Issue 204: Parse war3map.w3c (Cameras)

**Phase:** 2 - Data Model
**Type:** Feature
**Priority:** Medium
**Dependencies:** 102-implement-mpq-archive-parser

---

## Current Behavior

Cannot read camera preset definitions. Cinematic cameras, gameplay cameras,
and camera bounds are inaccessible for rendering and scripting.

---

## Intended Behavior

A parser that extracts all camera definitions from war3map.w3c:
- Camera names
- Target positions
- Camera angles (rotation, AOA, roll)
- Distance and field of view
- Clipping planes

---

## Suggested Implementation Steps

1. **Create parser module**
   ```
   src/parsers/
   └── w3c.lua          (this issue)
   ```

2. **Implement header parsing**
   ```lua
   -- war3map.w3c header structure:
   -- Offset  Type      Description
   -- 0x00    int32     File version (0 for original)
   -- 0x04    int32     Number of cameras
   ```

3. **Implement camera entry parsing (pre-1.31)**
   ```lua
   -- Each camera entry (variable size):
   -- float:   Target X coordinate
   -- float:   Target Y coordinate
   -- float:   Z offset (height above target)
   -- float:   Rotation (degrees, 0 = north, clockwise)
   -- float:   Angle of Attack (degrees, 0 = horizontal)
   -- float:   Distance from target
   -- float:   Roll (degrees)
   -- float:   Field of View (degrees, default 70)
   -- float:   Far clipping plane
   -- float:   Near clipping plane (100.0 default placeholder)
   -- string:  Camera name (null-terminated)
   ```

4. **Implement camera entry parsing (1.31+)**
   ```lua
   -- Extended format adds local rotations after name:
   -- float:   Local pitch (degrees)
   -- float:   Local yaw (degrees)
   -- float:   Local roll (degrees)
   ```

5. **Detect version from war3map.w3i**
   ```lua
   -- Check editor version in w3i to determine format:
   -- < 1.31: Standard format (no local rotations)
   -- >= 1.31: Extended format with local rotations
   ```

6. **Return structured data**
   ```lua
   return {
       version = 0,
       cameras = {
           {
               name = "gg_cam_Camera_001",
               target = { x = 0.0, y = 0.0 },
               z_offset = 1650.0,
               rotation = 90.0,       -- Degrees
               aoa = 304.0,           -- Angle of attack
               distance = 1650.0,
               roll = 0.0,
               fov = 70.0,
               far_clip = 5000.0,
               near_clip = 100.0,
               -- 1.31+ only:
               local_pitch = 0.0,
               local_yaw = 0.0,
               local_roll = 0.0,
           },
           -- ...
       },
   }
   ```

---

## Technical Notes

### Camera Coordinate System

- Target X/Y: World coordinates (same as units/regions)
- Z offset: Height above the target point
- Rotation: 0 = camera facing north, increases clockwise
- AOA: Angle downward from horizontal (90 = looking straight down)
- Distance: Distance from camera to target point

### Default Camera Values

```lua
local CAMERA_DEFAULTS = {
    z_offset = 0.0,
    rotation = 90.0,
    aoa = 304.0,      -- Typical RTS camera angle
    distance = 1650.0,
    roll = 0.0,
    fov = 70.0,
    far_clip = 5000.0,
    near_clip = 100.0,
}
```

### Camera Naming Convention

Editor-generated cameras follow pattern: `gg_cam_<name>`

### Version Detection Problem

Blizzard did not update the file version when adding local rotations in 1.31.
This means we must check the editor version from war3map.w3i to correctly
parse the format. Maps saved in 1.31+ will have 12 extra bytes per camera.

### Usage in Scripts

Cameras are typically used for:
- Cinematic sequences (`SetCameraTargetController`, `SetCameraPosition`)
- Gameplay camera presets
- Map intro/outro sequences

---

## Related Documents

- docs/formats/w3c-cameras.md (to be created)
- issues/102-implement-mpq-archive-parser.md (provides file access)
- issues/103-parse-war3map-w3i.md (provides editor version for format detection)

---

## Acceptance Criteria

- [x] Can parse war3map.w3c from all test archives
- [x] Correctly extracts camera names
- [x] Correctly extracts target positions
- [x] Correctly extracts rotation, AOA, roll
- [x] Correctly extracts distance and FOV
- [x] Correctly extracts clipping planes
- [x] Detects 1.31+ format and parses local rotations
- [x] Returns structured Lua table
- [x] Unit tests for parser

---

## Notes

Camera parsing is straightforward but has a version detection caveat.
Since Blizzard didn't update the file version in 1.31, we need to
check the editor version from w3i to know which format to expect.

A robust implementation might try to detect the format by checking
if the file size matches expected size for N cameras in either format.

Reference: [WC3MapSpecification](https://github.com/ChiefOfGxBxL/WC3MapSpecification)
Reference: [HIVE Forums](https://www.hiveworkshop.com/threads/parsing-old-new-war3map-w3c-files.328473/)

---

## Sub-Issue Analysis

*Generated by Claude Code on 2025-12-16 05:36*

Looking at this issue, I'll analyze whether it would benefit from splitting into sub-issues.

## Analysis

This issue is relatively **self-contained and focused**. It covers:
1. A single file format (war3map.w3c)
2. Two format variants (pre-1.31 and 1.31+)
3. Version detection via w3i
4. Straightforward binary parsing

The complexity is moderate - the main challenge is the version detection caveat, not the parsing itself.

## Recommendation: **Keep as-is (no split)**

**Reasoning:**

1. **Single responsibility** - This is one parser for one file format. The two format variants are minor differences (12 extra bytes), not separate concerns.

2. **Low complexity** - The camera structure is simple: 10 floats + 1 string + optionally 3 more floats. Compare this to more complex formats like w3i which has many sections.

3. **Natural implementation flow** - A developer would naturally:
   - Write the header parsing
   - Write the camera entry parsing
   - Add the version detection
   - Test both variants
   
   These steps are too tightly coupled to benefit from separate issues.

4. **Version detection is integral** - The w3i dependency for version detection isn't complex enough to warrant its own sub-issue. It's a simple check: `if editor_version >= 131 then use_extended_format end`.

5. **Estimated effort** - This is roughly 100-150 lines of Lua. Splitting would add overhead without meaningful benefit.

## Alternative consideration

If you wanted to split for tracking purposes, the only reasonable split would be:

| ID | Name | Description |
|----|------|-------------|
| 204a | parse-w3c-standard-format | Pre-1.31 camera parsing (10 floats + string) |
| 204b | parse-w3c-extended-format | 1.31+ additions (local rotations) + version detection |

But I'd advise against this because:
- 204b would be a trivial addition on top of 204a
- The version detection logic belongs with the parsing, not separate
- Testing both variants naturally happens together

**Verdict:** Implement 204 as a single issue. It's appropriately scoped.

---

## Implementation Notes

*Completed on 2025-12-16*

### Files Created

| File | Description |
|------|-------------|
| `src/parsers/w3c.lua` | Camera parser module (~200 lines) |
| `src/tests/test_w3c.lua` | Test suite with synthetic data and map validation |
| `src/tests/check_file_presence.lua` | Utility to check file presence across maps |

### Implementation Details

1. **Parser structure** - Follows established patterns from w3r.lua and w3i.lua:
   - Uses `compat.lua` for LuaJIT/Lua 5.3+ compatibility
   - Local binary reading utilities (`read_int32`, `read_float32`, `read_string`)
   - Vimfolds for code organization
   - `parse()` returns structured data, `format()` returns human-readable output

2. **Version detection** - Implemented dual approach:
   - Primary: Accept `editor_version` parameter from w3i parser
   - Fallback: Heuristic based on average bytes per camera entry
   - Returns `result.extended` boolean to indicate which format was detected

3. **Camera lookup** - Built `by_name` index for fast lookups via `w3c.get_camera()`

4. **Test coverage**:
   - 6 synthetic data tests (empty, single, multiple cameras, lookup, format, invalid data)
   - 16 map tests (all pass - no test maps contain cameras)
   - Total: 22/22 tests passing

### Test Results

```
Synthetic tests: 6 passed, 0 failed
Map tests: 16 passed, 0 failed
Total: 22 / 22
ALL TESTS PASSED
```

### Notes

- None of the 16 test maps contain war3map.w3c files (cameras are optional)
- Synthetic tests validate all parsing logic including extended format support
- Created `check_file_presence.lua` utility for debugging file presence across maps
