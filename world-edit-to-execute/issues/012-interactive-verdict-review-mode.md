# Issue 012: Interactive Verdict Review Mode

**Phase:** 0 (Tooling)
**Status:** Pending
**Affects:** src/cli/issue-splitter.sh, scripts/libs/

---

## Current Behavior

The issue-splitter's Execute mode (`-x`) attempts to parse Claude's analysis sections to detect whether it recommends splitting. This parsing is brittle because:

1. Claude may phrase recommendations differently each time
2. Verdict keywords may appear in different formats (e.g., "## Recommendation: Do Not Split" vs "I don't recommend splitting")
3. Sub-headings within analysis sections can interfere with section boundary detection
4. Hard-coding syntax patterns couples the tool tightly to AI output format

Currently, issues are pre-selected in the TUI based on a `get_analysis_verdict()` function that uses regex matching, which often returns "unknown" for valid analyses.

---

## Intended Behavior

Replace automated verdict parsing with an **interactive review mode** that presents each analyzed issue to the user for manual decision-making.

### User Flow

1. User selects "Execute Recommendations" mode in TUI
2. For each issue with analysis:
   - Display the analysis section (or full file if none found) in a scrollable viewer
   - Show hotkey options at bottom
   - User reads analysis and decides
3. After all reviews complete, execute only the approved issues
4. Show summary of decisions made

### Viewer Interface

```
┌─ Review: 201-parse-war3map-doo.md ─────────────────────────┐
│                                                             │
│ ## Sub-Issue Analysis                                       │
│                                                             │
│ *Generated by Claude Code on 2025-12-20 14:30*              │
│                                                             │
│ Looking at this issue, I think it **would benefit from      │
│     splitting** into sub-issues. The parser has distinct    │
│     structural components that can be implemented           │
│     incrementally...                                        │
│                                                             │
│ ## Recommended Sub-Issues                                   │
│                                                             │
│ - 201a: Parse doodad header and basic structure             │
│ - 201b: Parse doodad definitions                            │
│ - 201c: Parse special doodad table                          │
│ - 201d: Integration and testing                             │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [e] Execute  [s] Skip  [q] Quit           (Issue 3 of 15)  │
└─────────────────────────────────────────────────────────────┘
```

### Hotkeys

| Key | Action | Description |
|-----|--------|-------------|
| `e` | Execute | Create sub-issues for this issue |
| `s` | Skip | Don't split this issue |
| `q` | Quit | Stop reviewing, don't execute any remaining |
| `j`/`k` or `↓`/`↑` | Scroll | Navigate through content |
| `g`/`G` | Jump | Go to top/bottom of content |

### Summary Output

After review completes:
```
Verdict Review Complete
=======================
Execute (create sub-issues): 5
  - 201-parse-war3map-doo.md
  - 301-parse-war3map-wtg.md
  - ...
Skip (keep as-is): 3
  - 001-fix-issue-splitter-output-handling.md
  - ...

Proceed with execution? [y/N]
```

---

## Suggested Implementation Steps

### Step 1: Create verdict-viewer.lua (or extend input-dialog.lua)

The viewer functionality already exists in `input-dialog.lua` used for feedback mode. Options:

**Option A: Add view-only mode to input-dialog.lua**
- Add `--view-only` flag that disables text input
- Change button area to show hotkey options
- Return decision via stdout ("execute", "skip", "quit")

**Option B: Create dedicated verdict-viewer.lua**
- Simpler, purpose-built script
- Reuse rendering code from input-dialog.lua
- May be cleaner separation of concerns

Recommended: **Option A** - Less code duplication, viewer is just input-dialog without input.

### Step 2: Add content extraction helper

Create bash function to extract displayable content:
```bash
get_review_content() {
    local file="$1"
    # Try to extract analysis sections
    # If none found, return full file content
    # Return via stdout
}
```

### Step 3: Modify execute mode in issue-splitter.sh

Replace current execute logic:
```bash
# Old: Parse verdict and auto-select
verdict=$(get_analysis_verdict "$issue")

# New: Show to user and get decision
decision=$(show_verdict_review "$issue")
case "$decision" in
    execute) ISSUES_TO_EXECUTE+=("$issue") ;;
    skip) ISSUES_SKIPPED+=("$issue") ;;
    quit) break ;;
esac
```

### Step 4: Add summary and confirmation

After review loop:
- Display counts and file lists
- Prompt for final confirmation before creating sub-issues

### Step 5: Update documentation

- Update CLAUDE.md with new execute mode workflow
- Remove references to automated verdict detection

---

## Related Documents

- `/home/ritz/programming/ai-stuff/scripts/libs/input-dialog.lua` - Existing TUI input dialog (has viewer code)
- `/home/ritz/programming/ai-stuff/scripts/libs/tui.lua` - Core TUI library
- `src/cli/issue-splitter.sh` - Main script to modify
- `CLAUDE.md` - Documentation to update

---

## Acceptance Criteria

- [ ] Viewer displays analysis section content with word-wrapping
- [ ] Scrolling works (j/k, arrows, g/G)
- [ ] Hotkeys e/s/q work and return correct decision
- [ ] Issue counter shows progress (e.g., "Issue 3 of 15")
- [ ] Summary displays after all reviews complete
- [ ] Final confirmation prompt before execution
- [ ] Quit option stops review early without executing
- [ ] Falls back to full file content if no analysis section found
- [ ] Old `get_analysis_verdict()` function removed or deprecated
- [ ] Documentation updated

---

## Notes

This approach is more robust than text parsing because:
1. Human judgement is applied to each decision
2. No coupling to specific AI output formats
3. User can see full context before deciding
4. Works even when Claude phrases things unexpectedly

The feedback loop input-dialog.lua already has all the TUI infrastructure needed - this is essentially the same viewer but read-only with different action buttons.
