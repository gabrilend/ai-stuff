#!/bin/bash
# {{{ build-dependencies
# Build script for setting up local Emscripten SDK
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Accept DIR as argument
if [ "$1" != "" ]; then
    DIR="$1"
fi

echo "Building dependencies for Game Boy Color RPG..."
echo "Project directory: $DIR"
echo ""

# Interactive mode flag
INTERACTIVE=false
if [ "$1" = "-I" ] || [ "$2" = "-I" ]; then
    INTERACTIVE=true
fi

# {{{ select_emscripten_version
select_emscripten_version() {
    if [ "$INTERACTIVE" = true ]; then
        echo "Select Emscripten version:"
        echo "1. Latest stable (recommended)"
        echo "2. Specific version (3.1.50)"
        echo "3. Latest development"
        
        read -p "Choice (1-3, or index): " choice
        case $choice in
            1|"Latest stable"|"latest")
                EMSDK_VERSION="latest"
                ;;
            2|"Specific version"|"3.1.50")
                EMSDK_VERSION="3.1.50"
                ;;
            3|"Latest development"|"tot")
                EMSDK_VERSION="tot"
                ;;
            *)
                echo "Invalid choice, using latest stable"
                EMSDK_VERSION="latest"
                ;;
        esac
    else
        EMSDK_VERSION="latest"
    fi
    
    echo "Selected Emscripten version: $EMSDK_VERSION"
}
# }}}

# {{{ check_dependencies
check_dependencies() {
    echo "Checking system dependencies..."
    
    # Check for required tools
    MISSING_DEPS=""
    
    if ! command -v git &> /dev/null; then
        MISSING_DEPS="$MISSING_DEPS git"
    fi
    
    if ! command -v python3 &> /dev/null; then
        MISSING_DEPS="$MISSING_DEPS python3"
    fi
    
    if ! command -v cmake &> /dev/null; then
        MISSING_DEPS="$MISSING_DEPS cmake"
    fi
    
    if ! command -v make &> /dev/null; then
        MISSING_DEPS="$MISSING_DEPS make"
    fi
    
    if [ ! -z "$MISSING_DEPS" ]; then
        echo "Error: Missing required dependencies:$MISSING_DEPS"
        echo "Please install them using your system package manager:"
        echo "  Ubuntu/Debian: sudo apt install$MISSING_DEPS"
        echo "  Arch: sudo pacman -S$MISSING_DEPS"
        echo "  Fedora: sudo dnf install$MISSING_DEPS"
        exit 1
    fi
    
    echo "✓ All system dependencies found"
}
# }}}

# {{{ setup_emscripten
setup_emscripten() {
    echo ""
    echo "Setting up Emscripten SDK..."
    
    EMSDK_DIR="$DIR/libs/emsdk"
    
    # Remove existing emsdk if it exists
    if [ -d "$EMSDK_DIR" ]; then
        echo "Removing existing Emscripten installation..."
        rm -rf "$EMSDK_DIR"
    fi
    
    # Create libs directory
    mkdir -p "$DIR/libs"
    
    # Clone emsdk
    echo "Cloning Emscripten SDK..."
    cd "$DIR/libs"
    git clone https://github.com/emscripten-core/emsdk.git
    
    if [ $? -ne 0 ]; then
        echo "✗ Failed to clone Emscripten SDK"
        exit 1
    fi
    
    # Enter emsdk directory
    cd emsdk
    
    # Install and activate the selected version
    echo "Installing Emscripten version: $EMSDK_VERSION"
    ./emsdk install "$EMSDK_VERSION"
    
    if [ $? -ne 0 ]; then
        echo "✗ Failed to install Emscripten"
        exit 1
    fi
    
    echo "Activating Emscripten..."
    ./emsdk activate "$EMSDK_VERSION"
    
    if [ $? -ne 0 ]; then
        echo "✗ Failed to activate Emscripten"
        exit 1
    fi
    
    echo "✓ Emscripten SDK installed successfully"
}
# }}}

# {{{ create_activation_script
create_activation_script() {
    echo ""
    echo "Creating activation script..."
    
    cat > "$DIR/scripts/activate-emscripten" << 'EOF'
#!/bin/bash
# {{{ activate-emscripten
# Activate local Emscripten environment
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Accept DIR as argument
if [ "$1" != "" ]; then
    DIR="$1"
fi

EMSDK_DIR="$DIR/libs/emsdk"

if [ ! -d "$EMSDK_DIR" ]; then
    echo "Error: Emscripten not found at $EMSDK_DIR"
    echo "Run ./scripts/build-dependencies first"
    exit 1
fi

# Source the emsdk environment
source "$EMSDK_DIR/emsdk_env.sh"

echo "✓ Emscripten environment activated"
echo "  emcc: $(which emcc)"
echo "  Version: $(emcc --version | head -n1)"
# }}}
EOF
    
    chmod +x "$DIR/scripts/activate-emscripten"
    echo "✓ Created activation script: scripts/activate-emscripten"
}
# }}}

# {{{ verify_installation
verify_installation() {
    echo ""
    echo "Verifying installation..."
    
    # Source the environment
    source "$DIR/libs/emsdk/emsdk_env.sh"
    
    # Test emcc
    if command -v emcc &> /dev/null; then
        echo "✓ emcc found: $(which emcc)"
        echo "✓ Version: $(emcc --version | head -n1)"
        
        # Test simple compilation
        echo "Testing compilation..."
        echo 'int main() { return 42; }' > /tmp/test.c
        emcc /tmp/test.c -o /tmp/test.wasm --no-entry
        
        if [ $? -eq 0 ]; then
            echo "✓ Compilation test successful"
            rm -f /tmp/test.c /tmp/test.wasm
        else
            echo "✗ Compilation test failed"
            exit 1
        fi
    else
        echo "✗ emcc not found after installation"
        exit 1
    fi
}
# }}}

# {{{ Main execution
# Main script execution
echo "=== Emscripten SDK Setup ==="

select_emscripten_version
check_dependencies
setup_emscripten
create_activation_script
verify_installation

echo ""
echo "=== Setup Complete ==="
echo ""
echo "✓ Emscripten SDK installed to: libs/emsdk"
echo "✓ Activation script created: scripts/activate-emscripten"
echo ""
echo "Usage:"
echo "  1. Activate environment: source scripts/activate-emscripten"
echo "  2. Build game: ./build.sh"
echo ""
echo "Or use the build script which automatically activates the environment."
# }}}
# }}}