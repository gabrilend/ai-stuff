#!/bin/bash

# {{{ RPG Autobattler Test Runner
# Script to test and demonstrate various functionalities

# Set up directory path
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
if [ $# -gt 0 ]; then
    DIR="$1"
fi

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# {{{ print_header
print_header() {
    echo -e "${CYAN}================================${NC}"
    echo -e "${CYAN}  RPG Autobattler Test Runner${NC}"
    echo -e "${CYAN}================================${NC}"
    echo ""
}
# }}}

# {{{ print_section
print_section() {
    echo -e "${BLUE}--- $1 ---${NC}"
}
# }}}

# {{{ print_success
print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}
# }}}

# {{{ print_error
print_error() {
    echo -e "${RED}âœ— $1${NC}"
}
# }}}

# {{{ print_warning
print_warning() {
    echo -e "${YELLOW}âš  $1${NC}"
}
# }}}

# {{{ print_info
print_info() {
    echo -e "${PURPLE}â„¹ $1${NC}"
}
# }}}

# {{{ check_love2d
check_love2d() {
    print_section "Checking Prerequisites"
    
    if command -v love &> /dev/null; then
        local version=$(love --version 2>/dev/null | head -n 1)
        print_success "LÃ–VE 2D found: $version"
        return 0
    elif command -v love2d &> /dev/null; then
        local version=$(love2d --version 2>/dev/null | head -n 1)
        print_success "LÃ–VE 2D found: $version"
        return 0
    else
        print_error "LÃ–VE 2D not found. Please install LÃ–VE 2D to run the game."
        print_info "Visit: https://love2d.org/"
        return 1
    fi
}
# }}}

# {{{ check_lua_syntax
check_lua_syntax() {
    print_section "Checking Lua Syntax"
    
    local error_count=0
    local total_files=0
    
    while IFS= read -r -d '' file; do
        ((total_files++))
        # Use luac to check syntax without trying to load/execute
        if command -v luac &> /dev/null; then
            if ! luac -p "$file" 2>/dev/null; then
                print_error "Syntax error in: $file"
                ((error_count++))
            fi
        else
            # Fallback: just check if lua can parse the file without executing
            if ! lua -e "assert(loadfile('$file'))" 2>/dev/null; then
                print_error "Syntax error in: $file"
                ((error_count++))
            fi
        fi
    done < <(find "$DIR/src" -name "*.lua" -print0 2>/dev/null)
    
    if [ $error_count -eq 0 ]; then
        print_success "All $total_files Lua files have valid syntax"
    else
        print_error "$error_count/$total_files files have syntax errors"
        return 1
    fi
}
# }}}

# {{{ analyze_project_structure
analyze_project_structure() {
    print_section "Project Structure Analysis"
    
    # Count different types of files
    local lua_files=$(find "$DIR/src" -name "*.lua" 2>/dev/null | wc -l)
    local system_files=$(find "$DIR/src/systems" -name "*.lua" 2>/dev/null | wc -l)
    local component_files=$(find "$DIR/src/components" -name "*.lua" 2>/dev/null | wc -l)
    local entity_files=$(find "$DIR/src/entities" -name "*.lua" 2>/dev/null | wc -l)
    local util_files=$(find "$DIR/src/utils" -name "*.lua" 2>/dev/null | wc -l)
    
    print_info "Lua files: $lua_files"
    print_info "Systems: $system_files"
    print_info "Components: $component_files"
    print_info "Entities: $entity_files"
    print_info "Utilities: $util_files"
    
    # Check for key files
    local key_files=(
        "main.lua"
        "src/systems/map_renderer.lua"
        "src/systems/collision_system.lua"
        "src/systems/unit_movement_system.lua"
        "src/systems/lane_following_system.lua"
        "src/systems/obstacle_avoidance_system.lua"
        "src/systems/formation_system.lua"
        "src/systems/unit_queueing_system.lua"
        "src/entities/unit.lua"
        "src/utils/vector2.lua"
        "src/constants/colors.lua"
    )
    
    print_info "Key files status:"
    for file in "${key_files[@]}"; do
        if [ -f "$DIR/$file" ]; then
            print_success "$file"
        else
            print_error "$file (missing)"
        fi
    done
}
# }}}

# {{{ show_implemented_features
show_implemented_features() {
    print_section "Implemented Features"
    
    echo -e "${GREEN}âœ“ Phase 1: Foundation & Setup${NC}"
    echo "  - LÃ–VE 2D project structure"
    echo "  - Entity-Component System (ECS)"
    echo "  - Vector math utilities"
    echo "  - Color palette and rendering primitives"
    echo ""
    
    echo -e "${GREEN}âœ“ Phase 2.1: Map Generation${NC}"
    echo "  - Random path generation algorithm"
    echo "  - Lane system with 5 sub-paths"
    echo "  - Spawn points for both players"
    echo "  - Basic map rendering with visual feedback"
    echo "  - Collision detection for lane boundaries"
    echo ""
    
    echo -e "${GREEN}âœ“ Phase 2.2: Basic Unit System${NC}"
    echo "  - Unit entities (melee, ranged, tank, support, special)"
    echo "  - Unit movement along sub-paths"
    echo "  - A* pathfinding with obstacle avoidance for sub-path navigation"
    echo "  - Enhanced unit rendering with shape-based type identification"
    echo "  - Colorblind-friendly visual design with team indicators"
    echo "  - Enhanced unit spawning with formation positioning and smart sub-path selection"
    echo "  - Spawn point validation, collision avoidance, and visual spawn effects"
    echo ""
    
    echo -e "${GREEN}âœ“ Phase 2.3: Movement Mechanics${NC}"
    echo "  - Enhanced lane following with path progress tracking and obstacle avoidance"
    echo "  - Formation maintenance and lane discipline with boundary enforcement"
    echo "  - Obstacle avoidance around allies"
    echo "  - Formation preservation (line, column, wedge, box, spread)"
    echo "  - Unit queueing when space is limited"
    echo "  - Comprehensive movement testing system"
    echo ""
    
    echo -e "${YELLOW}ðŸš§ Phase 3: Combat Foundation${NC}"
    echo "  - Unit-to-unit detection and engagement (in progress)"
    echo "  - Basic combat system (planned)"
    echo "  - Health system and unit death (planned)"
    echo ""
}
# }}}

# {{{ run_basic_test
run_basic_test() {
    print_section "Running Basic Game Test"
    
    if [ ! -f "$DIR/main.lua" ]; then
        print_error "main.lua not found in $DIR"
        return 1
    fi
    
    print_info "Starting LÃ–VE 2D..."
    print_info "This will open the game window. Close it to continue."
    print_info "Look for:"
    print_info "  - Generated map with pathways"
    print_info "  - Spawn points for both players"
    print_info "  - Grid background"
    print_info "  - Node connections"
    
    cd "$DIR"
    
    # Try different ways to run LÃ–VE 2D
    if command -v love &> /dev/null; then
        love . 2>/dev/null
    elif command -v love2d &> /dev/null; then
        love2d . 2>/dev/null
    else
        print_error "Could not find LÃ–VE 2D executable"
        return 1
    fi
    
    print_success "Basic test completed"
}
# }}}

# {{{ run_unit_tests
run_unit_tests() {
    print_section "Running Unit Tests"
    
    # Test Vector2 utility
    print_info "Testing Vector2 utility..."
    cd "$DIR"
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local Vector2 = require('src.utils.vector2')
    
    -- Test basic operations
    local v1 = Vector2:new(3, 4)
    local v2 = Vector2:new(1, 2)
    
    assert(v1:length() == 5, 'Vector length test failed')
    assert(v1:add(v2).x == 4 and v1:add(v2).y == 6, 'Vector addition test failed')
    assert(v1:dot(v2) == 11, 'Vector dot product test failed')
    
    print('âœ“ Vector2 tests passed')
    " 2>/dev/null && print_success "Vector2 utility tests passed" || print_error "Vector2 utility tests failed"
    
    # Test Unit entity
    print_info "Testing Unit entity creation..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local Unit = require('src.entities.unit')
    
    -- Test unit type functions
    assert(Unit.get_unit_base_health('melee') == 120, 'Melee health test failed')
    assert(Unit.get_unit_base_speed('ranged') == 45, 'Ranged speed test failed')
    assert(Unit.get_unit_shape('tank') == 'rectangle', 'Tank shape test failed')
    
    print('âœ“ Unit entity tests passed')
    " 2>/dev/null && print_success "Unit entity tests passed" || print_error "Unit entity tests failed"
    
    # Test Colors constants
    print_info "Testing Colors constants..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local Colors = require('src.constants.colors')
    
    assert(Colors.TEAM_A and #Colors.TEAM_A == 4, 'TEAM_A color test failed')
    assert(Colors.TEAM_B and #Colors.TEAM_B == 4, 'TEAM_B color test failed')
    assert(type(Colors.get_health_color(0.5)) == 'table', 'Health color function test failed')
    
    print('âœ“ Colors tests passed')
    " 2>/dev/null && print_success "Colors constants tests passed" || print_error "Colors constants tests failed"
    
    # Test Unit template system
    print_info "Testing Unit template system..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local Unit = require('src.entities.unit')
    
    -- Test template validation
    Unit.test_template_validation()
    
    -- Test unit creation
    Unit.test_unit_creation()
    
    print('âœ“ Unit template tests passed')
    " 2>/dev/null && print_success "Unit template system tests passed" || print_error "Unit template system tests failed"
    
    # Test Unit Movement System
    print_info "Testing Unit Movement System..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local EntityManager = require('src.systems.entity_manager')
    local UnitMovementSystem = require('src.systems.unit_movement_system')
    
    -- Create test movement system
    local entity_manager = EntityManager:new()
    local movement_system = UnitMovementSystem:new(entity_manager, nil)
    
    -- Test path following calculations
    movement_system:test_path_following()
    
    -- Test movement integration
    movement_system:test_movement_integration()
    
    print('âœ“ Unit movement tests passed')
    " 2>/dev/null && print_success "Unit Movement System tests passed" || print_error "Unit Movement System tests failed"
    
    # Test Pathfinding System
    print_info "Testing Pathfinding System..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local EntityManager = require('src.systems.entity_manager')
    local PathfindingSystem = require('src.systems.pathfinding_system')
    
    -- Create test pathfinding system
    local entity_manager = EntityManager:new()
    local pathfinding_system = PathfindingSystem:new(entity_manager, nil)
    
    -- Test sub-path pathfinding
    pathfinding_system:test_subpath_pathfinding()
    
    print('âœ“ Pathfinding tests passed')
    " 2>/dev/null && print_success "Pathfinding System tests passed" || print_error "Pathfinding System tests failed"
    
    # Test Enhanced Unit Rendering System
    print_info "Testing Enhanced Unit Rendering System..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local EntityManager = require('src.systems.entity_manager')
    local UnitRenderSystem = require('src.systems.unit_render_system')
    
    -- Create test rendering system
    local entity_manager = EntityManager:new()
    local render_system = UnitRenderSystem:new(entity_manager, nil)
    
    -- Test enhanced rendering features
    render_system:test_enhanced_rendering()
    
    print('âœ“ Enhanced rendering tests passed')
    " 2>/dev/null && print_success "Enhanced Unit Rendering System tests passed" || print_error "Enhanced Unit Rendering System tests failed"
    
    # Test Enhanced Unit Spawning System
    print_info "Testing Enhanced Unit Spawning System..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local EntityManager = require('src.systems.entity_manager')
    local UnitSpawningSystem = require('src.systems.unit_spawning_system')
    local Vector2 = require('src.utils.vector2')
    
    -- Create mock map data for testing
    local mock_map_data = {
        spawn_points = {
            player_1 = Vector2:new(100, 300),
            player_2 = Vector2:new(700, 300)
        },
        connections = {
            {from = Vector2:new(150, 300), to = Vector2:new(650, 300)}
        }
    }
    
    -- Create test spawning system
    local entity_manager = EntityManager:new()
    local spawning_system = UnitSpawningSystem:new(entity_manager, mock_map_data, nil)
    
    -- Test enhanced spawning features
    spawning_system:test_enhanced_spawning()
    
    print('âœ“ Enhanced spawning tests passed')
    " 2>/dev/null && print_success "Enhanced Unit Spawning System tests passed" || print_error "Enhanced Unit Spawning System tests failed"
    
    # Test Enhanced Lane Following System
    print_info "Testing Enhanced Lane Following System..."
    lua -e "
    package.path = './src/?.lua;./src/?/init.lua;' .. package.path
    local EntityManager = require('src.systems.entity_manager')
    local LaneFollowingSystem = require('src.systems.lane_following_system')
    
    -- Create test lane following system
    local entity_manager = EntityManager:new()
    local lane_following_system = LaneFollowingSystem:new(entity_manager, nil, nil)
    
    -- Test enhanced lane following features
    lane_following_system:test_enhanced_lane_following()
    
    print('âœ“ Enhanced lane following tests passed')
    " 2>/dev/null && print_success "Enhanced Lane Following System tests passed" || print_error "Enhanced Lane Following System tests failed"
}
# }}}

# {{{ demonstrate_systems
demonstrate_systems() {
    print_section "System Demonstrations"
    
    print_info "Map Generation System:"
    echo "  - Generates random pathway networks"
    echo "  - Creates 5 sub-paths per lane"
    echo "  - Places spawn points for both players"
    echo "  - Connects nodes with curved pathways"
    echo ""
    
    print_info "Unit System:"
    echo "  - 5 unit types: melee, ranged, tank, support, special"
    echo "  - Different stats, colors, and shapes per type"
    echo "  - Health and team management"
    echo "  - Position and movement components"
    echo ""
    
    print_info "Movement Systems:"
    echo "  - Lane following with path adherence correction"
    echo "  - Obstacle avoidance using spatial grids"
    echo "  - Formation preservation (5 formation types)"
    echo "  - Automatic queueing when paths are blocked"
    echo ""
    
    print_info "Rendering System:"
    echo "  - Map visualization with grid and pathways"
    echo "  - Unit rendering with health bars"
    echo "  - Team color coding"
    echo "  - Debug information overlays"
    echo ""
}
# }}}

# {{{ show_controls
show_controls() {
    print_section "Game Controls & Features"
    
    print_info "When running the game, you can expect to see:"
    echo "  - Generated map with colored pathways"
    echo "  - Player spawn points (blue and orange circles)"
    echo "  - Node network connecting pathways"
    echo "  - Background grid for reference"
    echo ""
    
    print_info "Systems working behind the scenes:"
    echo "  - Lane system managing 5 sub-paths per lane"
    echo "  - Collision detection for boundaries"
    echo "  - Unit spawning and movement framework"
    echo "  - Formation and queueing logic"
    echo ""
    
    print_warning "Note: This is a development build focused on core systems"
    print_warning "Interactive unit spawning and combat are not yet implemented"
}
# }}}

# {{{ performance_analysis
performance_analysis() {
    print_section "Performance Analysis"
    
    print_info "Analyzing system complexity..."
    
    # Count lines of code
    local total_loc=0
    local system_loc=0
    
    if command -v wc &> /dev/null; then
        total_loc=$(find "$DIR/src" -name "*.lua" -exec wc -l {} + 2>/dev/null | tail -n 1 | awk '{print $1}')
        system_loc=$(find "$DIR/src/systems" -name "*.lua" -exec wc -l {} + 2>/dev/null | tail -n 1 | awk '{print $1}')
        
        print_info "Total lines of code: $total_loc"
        print_info "System code: $system_loc"
    fi
    
    # Analyze system complexity
    local complex_systems=(
        "unit_movement_system.lua"
        "lane_following_system.lua" 
        "obstacle_avoidance_system.lua"
        "formation_system.lua"
        "unit_queueing_system.lua"
    )
    
    print_info "Complex systems implemented:"
    for system in "${complex_systems[@]}"; do
        if [ -f "$DIR/src/systems/$system" ]; then
            local lines=$(wc -l < "$DIR/src/systems/$system" 2>/dev/null || echo "?")
            print_success "$system ($lines lines)"
        fi
    done
}
# }}}

# {{{ main_menu
main_menu() {
    while true; do
        echo ""
        print_section "Test Options"
        echo "1) Run basic game test (opens LÃ–VE 2D window)"
        echo "2) Check project structure and syntax" 
        echo "3) Run unit tests"
        echo "4) Show implemented features"
        echo "5) Demonstrate systems"
        echo "6) Performance analysis"
        echo "7) Show game controls/features"
        echo "8) Run all tests"
        echo "9) Exit"
        echo ""
        read -p "Choose an option (1-9): " choice
        
        case $choice in
            1) run_basic_test ;;
            2) check_lua_syntax && analyze_project_structure ;;
            3) run_unit_tests ;;
            4) show_implemented_features ;;
            5) demonstrate_systems ;;
            6) performance_analysis ;;
            7) show_controls ;;
            8) 
                check_lua_syntax
                analyze_project_structure
                run_unit_tests
                show_implemented_features
                performance_analysis
                print_info "All tests completed. Run option 1 to test the game visually."
                ;;
            9) 
                print_success "Thanks for testing RPG Autobattler!"
                exit 0
                ;;
            *)
                print_error "Invalid option. Please choose 1-9."
                ;;
        esac
    done
}
# }}}

# {{{ Main execution
main() {
    print_header
    
    # Check if we're in the right directory
    if [ ! -f "$DIR/main.lua" ]; then
        print_error "main.lua not found in $DIR"
        print_info "Please run this script from the RPG Autobattler project directory"
        exit 1
    fi
    
    # Check prerequisites
    if ! check_love2d; then
        print_warning "LÃ–VE 2D not found. Some tests will be skipped."
    fi
    
    # Show current directory
    print_info "Working directory: $DIR"
    
    # If arguments provided, run specific test
    if [ $# -eq 0 ]; then
        main_menu
    else
        case "$2" in
            "test") run_basic_test ;;
            "check") check_lua_syntax && analyze_project_structure ;;
            "unit") run_unit_tests ;;
            "features") show_implemented_features ;;
            "demo") demonstrate_systems ;;
            "perf") performance_analysis ;;
            "all") 
                check_lua_syntax
                analyze_project_structure  
                run_unit_tests
                show_implemented_features
                performance_analysis
                ;;
            *) 
                print_error "Unknown command: $2"
                print_info "Available commands: test, check, unit, features, demo, perf, all"
                exit 1
                ;;
        esac
    fi
}

# Run main function with all arguments
main "$@"
# }}}